<!DOCTYPE html>
<html lang="en" data-bs-theme="{{ user_theme or 'light' }}">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Request {{ request.rid }}: Submit {{ request.package }}</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" />

    <style>
        /* Required to show well comments */
        .comment {
            white-space: pre-wrap;
        }

        /* Required to show well diff */
        .diff-block {
            background: #f8f9fa;
            padding: 1rem;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 0.9rem;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        /* Required to cut the description */
        .text-truncate-container {
            position: relative;
            max-height: 10em; /* approx. 5 lines */
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .text-truncate-container.expanded {
            max-height: none;
        }

        .text-truncate-container pre {
            white-space: pre-wrap;
            margin-bottom: 0;
        }
    </style>
</head>

<body>
    <div class="container-xxl my-4">
        <div class="text-end">
            Last update:
            <time class="timeago" datetime="{{ lastupdate }}">{{ lastupdate }}</time>
        </div>

        <!-- Overview Section -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Overview</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-7">
                                <h3>
                                    Request {{ request.rid }}
                                    <small>
                                        <span class="badge text-bg-secondary ms-1">
                                            <i class="fas fa-code-pull-request me-1"></i>
                                            {{ request.state.name }}
                                        </span>
                                    </small>
                                </h3>
                                {% if request.description %}
                                    <div id="description-container" class="text-truncate-container collapsed">
                                        <pre id="description-text">{{ request.description }}</pre>
                                    </div>
                                    <button id="toggle-description"
                                            class="btn btn-sm btn-link p-0"
                                            aria-expanded="false"
                                            aria-controls="description-container">
                                        Show more
                                    </button>
                                {% endif %}
                            </div>

                            <!-- Right Column -->
                            <div class="col-md-5">
                                <ul class="list-unstyled">
                                    <li>
                                        <i class="fas fa-user text-success"></i> Created by
                                        <a href="{{ request.user_url }}/{{ request.creator }}">{{ request.creator }}</a>
                                        <time class="timeago" datetime="{{ request.state.created_utc }}" title="{{ request.state.created_utc.strftime('%Y-%m-%d %H:%M UTC') }}">
                                            {{ request.state.created_utc }}
                                        </time>
                                    </li>
                                    <li>
                                        <i class="fas fa-info-circle text-info"></i> In state
                                        <span class="fw-bold">{{ request.state.name }}</span>
                                        {% if request.state.name =="superseded" and request.state.superseded_by %}
                                            by
                                            {% if not standalone %}
                                                <a href="{{ request.state.superseded_by }}?apiurl={{ request.apiurl }}&amp;theme={{ user_theme }}">
                                            {% endif %}
                                            #{{request.state.superseded_by }}
                                            {% if not standalone %}
                                                </a>
                                            {% endif %}
                                        {% endif %}
                                    </li>
                                        <li><i class="fas fa-info-circle text-info"></i> OBS request: <a href="{{ request.external_url }}{{ request.rid }}">{{request.external_url}}{{ request.rid }}</a><li>
                                    {% set pending_reviews = request.reviews | selectattr('state', 'equalto', 'new') | list %}
                                    {% if pending_reviews %}
                                        {% for r in pending_reviews %}
                                            <li>
                                                <i class="fas fa-info-circle text-info"></i> Open review for
                                                {% if r.by_user %}
                                                    <i class="fas fa-user text-secondary"></i>
                                                    <a href="{{ request.user_url }}/{{ r.by_user }}">{{ r.by_user }}</a>
                                                {% elif r.by_group %}
                                                    <i class="fas fa-users text-secondary"></i>
                                                    <a href="{{ request.group_url }}{{ r.by_group }}">{{ r.by_group }}</a>
                                                {% elif r.by_project %}
                                                    <i class="fa fa-cubes text-secondary"></i>
                                                    <a href="{{ request.project_url }}{{ r.by_project }}">{{ r.by_project }}</a>
                                                {% else %}
                                                    <span class="text-muted">Unknown reviewer</span>
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    {% else %}
                                        <li>
                                            <i class="fas fa-check-circle text-success"></i> No pending reviews
                                        </li>
                                    {% endif %}
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submit Package Section -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card mb-3">
                    <div class="card-header">
                        <h5>Package {{ request.action.target_package }}</h5>
                    </div>
                    <div class="card-body">
                        {% if request.action.type == "delete" %}
                            Delete package
                            <a href="{{ request.package_url }}{{ request.action.target_project }}/{{ request.action.target_package }}">
                                {{ request.action.target_project }}/{{ request.action.target_package }}
                            </a>
                        {% elif request.action.type == "change_devel"  %}
                            <p>
                                Set package
                                <a href="{{ request.project_url }}{{ request.action.source_project }}">{{ request.action.source_project }}</a>
                                /
                                <a href="{{ request.package_url }}{{ request.action.source_project }}/{{ request.action.source_package }}">{{ request.action.source_package }}</a>
                                to be <strong>devel</strong> project/package of package
                                <a href="{{ request.project_url }}{{ request.action.target_project }}">{{ request.action.target_project }}</a>
                                /
                                <a href="{{ request.package_url }}{{ request.action.target_project }}/{{ request.action.target_package }}">{{ request.action.target_package }}</a>
                            </p>
                        {% else %}
                            <p>
                                Submit package
                                <a href="/project/{{ request.action.source_project }}?apiurl={{ request.apiurl }}&amp;theme={{ user_theme }}">{{ request.action.source_project }}</a>
                                /
                                <a href="/package/{{ request.action.source_project }}/{{ request.action.source_package }}?apiurl={{ request.apiurl }}&amp;theme={{ user_theme }}">{{ request.action.source_package }}</a>
                                to package
                                <a href="/project/{{ request.action.target_project }}?apiurl={{ request.apiurl }}&amp;theme={{ user_theme }}">{{ request.action.target_project }}</a>
                                /
                                <a href="/package/{{ request.action.target_project }}/{{ request.action.target_package }}?apiurl={{ request.apiurl }}&amp;theme={{ user_theme }}">{{ request.action.target_package }}</a>
                            </p>
                        {% endif %}

                        <hr />

                        <div class="row">
                            <!-- Diff Controls -->
                            <div class="col-12 mb-3">
                                <button class="btn btn-sm btn-outline-primary me-2" onclick="expandAllDiffs()">Expand All</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="collapseAllDiffs()">Collapse All</button>
                            </div>

                            <!-- Diffs -->
                            <div class="col-md-8">
                                {% if request.file_diffs %}
                                    {% for diff in request.file_diffs %}
                                        {% set collapse_id = 'diff-' ~ loop.index %}
                                        {% if diff.name_old and diff.name_new %}
                                            {% if diff.name_old == diff.name_new %}
                                                {% set filename = diff.name_new %}
                                            {% else %}
                                                {% set filename = diff.name_old ~ ' → ' ~ diff.name_new %}
                                            {% endif %}
                                        {% else %}
                                            {% set filename = diff.name_new or diff.name_old %}
                                        {% endif %}

                                        <div class="card mb-3 w-100">
                                            <div class="card-header">
                                                <a class="text-decoration-none" data-bs-toggle="collapse"
                                                   href="#{{ collapse_id }}" role="button" aria-expanded="false"
                                                   aria-controls="{{ collapse_id }}">
                                                    <i class="fas fa-code-branch text-muted"></i> {{ filename }}
                                                </a>
                                                <span class="ms-2 badge
                                                    {% if diff.state == 'added' %}bg-success
                                                    {% elif diff.state == 'deleted' %}bg-danger
                                                    {% else %}bg-secondary{% endif %}">
                                                    {{ diff.state }}
                                                </span>
                                            </div>
                                            {% if diff.content %}
                                            <div class="collapse {{ 'show' if loop.index<3 else '' }}" id="{{ collapse_id }}">
                                                <div class="card-body">
                                                    <pre><code class="diff">{{ diff.content | e }}</code></pre>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                {% endif %}
                            </div>

                            <!-- Sidebar -->
                            <div class="col-md-4">
                                <!-- Build Results -->
                                <div class="card mb-3">
                                    <div class="card-header"><h5>Build Results</h5></div>
                                    <div class="card-body">
                                        {% if request.results %}

                                            {% if request.staging %}
                                            From staging project
                                            <a href="{{ request.project_url }}{{ request.staging }}">{{ request.staging }}</a>
                                            {% else %}
                                            From devel project
                                            <a href="{{ request.project_url }}{{ request.action.source_project }}">{{ request.action.source_project }}</a>
                                            {% endif %}

                                            {% for package, repos in request.results.items() %}
                                                <h5 class="mt-4 text-primary">{{ package }}</h5>
                                                {% if request.staging %}
                                                {% set repositories = ['bootstrap_copy', 'images', 'product', 'standard'] %}
                                                {% else %}
                                                {% set repositories = repos %}
                                                {% endif %}
                                                {% for repo in repositories %}
                                                    {% if repo in repos %}
                                                        <div class="card mb-3">
                                                            <div class="card-header">
                                                                <strong>{{ repo }}</strong>
                                                            </div>
                                                            <div class="card-body">
                                                                {% for arch, results in repos[repo].items() %}
                                                                    <div class="d-flex align-items-start mb-2">
                                                                        <div class="me-3 d-flex align-items-center min-width-arch">
                                                                            <i class="fas fa-dolly-flatbed"></i>
                                                                            <span class="ms-2 fw-semibold" style="min-width: 120px;">{{ arch }}</span>
                                                                        </div>
                                                                        <div class="d-flex flex-wrap gap-2">
                                                                            {% for result in results %}
                                                                                <div>
                                                                                    <span class="badge bg-{{ 'success' if result.status_code == 'succeeded' else 'danger' }}"
                                                                                          {% if result.details %}
                                                                                              data-bs-toggle="tooltip"
                                                                                              title="{{ result.details }}"
                                                                                          {% endif %}>
                                                                                        {% if request.staging %}
                                                                                        <a href="{{ request.build_url}}{{ request.staging}}/{{package}}/{{repo}}/{{arch}}" class="text-white">{{ result.status_code }}</a>
                                                                                        {% else %}
                                                                                        <a href="{{ request.build_url}}{{ request.action.source_project}}/{{package}}/{{repo}}/{{arch}}" class="text-white">{{ result.status_code }}</a>
                                                                                        {% endif %}

                                                                                    </span>
                                                                                </div>
                                                                            {% endfor %}
                                                                        </div>
                                                                    </div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            {% endfor %}
                                        {% else %}
                                            <p class="text-muted">No build results available.</p>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Mentioned Issues -->
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <h5>Mentioned Issues ({{ request.issues|length }})</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="list-group list-group-flush">
                                            {% for issue in request.issues %}
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <span class="badge text-bg-info">{{ issue.state }}</span>
                                                    <a target="_blank" rel="noopener" href="{{ issue.url }}">{{ issue.label }}</a>
                                                </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments and History -->
        <div class="row">
            <!-- Comments -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header"><h5>Comments ({{ request.comments | length }})</h5></div>
                    <div class="card-body">
                        {% if request.comments %}
                            {% for comment in request.comments %}
                                <div class="mb-2">
                                    <div class="small text-muted">
                                        <strong>{{ comment.who }}</strong> on {{ comment.when }} - #{{ comment.id }}
                                        {% if comment.parent %}
                                            (in reply to #{{ comment.parent }})
                                        {% endif %}
                                    </div>
                                    <div class="comment">{{ comment.text | e }}</div>
                                    <hr />
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-muted">No comments available.</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- History -->
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header"><h5>Request History</h5></div>
                    <div class="card-body">
                        {% if request.history %}
                            {% for event in request.history %}
                                <div class="d-flex">
                                    <div class="flex-grow-1 text-break">
                                        <p>
                                            <strong>{{ event.who }}</strong> — {{ event.description }}
                                            <time datetime="{{ event.when.isoformat() }}Z"
                                                  title="{{ event.when.strftime('%Y-%m-%d %H:%M UTC') }}">
                                                <small class="text-muted">{{ event.timestamp_relative }}</small>
                                            </time>
                                        </p>
                                        {% if event.comment %}
                                            <div class="ps-2 border-start">
                                                <p><em>{{ event.comment }}</em></p>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if not loop.last %}
                                    <hr />
                                {% endif %}
                            {% endfor %}
                        {% else %}
                            <div class="text-muted">No review history available.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- This is for timeago-->
    <script src="https://unpkg.com/timeago.js/dist/timeago.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const nodes = document.querySelectorAll("time.timeago");
            timeago.render(nodes);
        });
    </script>

    <!-- This is for code highlight-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        {% if user_theme == 'dark' %}
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" />
        {% else %}
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" />
        {% endif %}
    <script>hljs.highlightAll();</script>

    <script> <!-- This is for he collapse buttons -->
        function expandAllDiffs() {
            document.querySelectorAll('.collapse').forEach(el => {
                new bootstrap.Collapse(el, { toggle: false }).show();
            });
        }

        function collapseAllDiffs() {
            document.querySelectorAll('.collapse').forEach(el => {
                new bootstrap.Collapse(el, { toggle: false }).hide();
            });
        }
    </script>

    <script> <!-- This is for the description -->
        document.addEventListener("DOMContentLoaded", function () {
            const toggleBtn = document.getElementById("toggle-description");
            const container = document.getElementById("description-container");

            toggleBtn.addEventListener("click", function () {
                container.classList.toggle("expanded");
                container.classList.toggle("collapsed");
                toggleBtn.textContent = container.classList.contains("expanded") ? "Show less" : "Show more";
            });
        });
    </script>
</body>
</html>
